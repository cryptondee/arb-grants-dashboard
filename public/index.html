<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrum DAO Season 3 Grant Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            line-height: 1.5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #30363d;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .last-updated {
            color: #8b949e;
            font-size: 0.9rem;
        }

        .reporting-period {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .reporting-period h2 {
            font-size: 1.3rem;
            margin-bottom: 16px;
            color: #28a0f0;
        }

        .date-picker-row {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .date-picker-row label {
            font-weight: 600;
            margin-right: 8px;
        }

        .date-picker-row input[type="date"] {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px 12px;
            color: #e6edf3;
            font-size: 0.95rem;
        }

        .period-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .period-summary .stat-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
        }

        .period-summary .stat-card .label {
            font-size: 0.85rem;
            color: #8b949e;
            margin-bottom: 4px;
        }

        .period-summary .stat-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        .sankey-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .sankey-container h3 {
            font-size: 1.1rem;
            margin-bottom: 16px;
            color: #28a0f0;
        }

        #sankeyDiagram {
            width: 100%;
            height: 400px;
        }

        .panels-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
        }

        .panel h3 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            color: #28a0f0;
        }

        .panel-stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .panel-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #30363d;
        }

        .panel-stat:last-child {
            border-bottom: none;
        }

        .panel-stat .label {
            color: #8b949e;
        }

        .panel-stat .value {
            font-weight: 600;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        .domain-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .domain-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .domain-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .domain-card.active {
            border-color: #28a0f0;
            box-shadow: 0 0 0 1px #28a0f0;
        }

        .domain-card .domain-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .domain-card .domain-count {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            margin-bottom: 4px;
        }

        .domain-card .domain-label {
            font-size: 0.85rem;
            color: #8b949e;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
        }

        .stat-card .label {
            font-size: 0.9rem;
            color: #8b949e;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
        }

        .chart-card h3 {
            font-size: 1.1rem;
            margin-bottom: 16px;
            color: #28a0f0;
        }

        .filter-bar {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .search-box {
            width: 100%;
            padding: 10px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 1rem;
            margin-bottom: 16px;
        }

        .search-box:focus {
            outline: none;
            border-color: #28a0f0;
        }

        .state-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .state-btn {
            padding: 8px 16px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .state-btn:hover {
            background: #161b22;
        }

        .state-btn.active {
            border-color: #28a0f0;
            background: rgba(40, 160, 240, 0.1);
        }

        .advanced-filters {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: #8b949e;
        }

        .filter-group select,
        .filter-group input[type="number"] {
            padding: 6px 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 0.9rem;
        }

        .filter-group input[type="number"] {
            width: 120px;
        }

        .toggle-btn {
            padding: 8px 16px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .toggle-btn:hover {
            background: #161b22;
        }

        .toggle-btn.active {
            border-color: #3fb950;
            background: rgba(63, 185, 80, 0.1);
        }

        .table-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #0d1117;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #30363d;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #30363d;
        }

        tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        tr:hover {
            background: rgba(40, 160, 240, 0.05);
        }

        .state-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .state-submitted { background: rgba(188, 140, 255, 0.2); color: #bc8cff; }
        .state-approved { background: rgba(63, 185, 80, 0.2); color: #3fb950; }
        .state-rejected { background: rgba(248, 81, 73, 0.2); color: #f85149; }
        .state-resubmit { background: rgba(210, 153, 34, 0.2); color: #d29922; }
        .state-review { background: rgba(40, 160, 240, 0.2); color: #28a0f0; }
        .state-cancelled { background: rgba(72, 79, 88, 0.2); color: #484f58; }

        .domain-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .domain-npi { background: rgba(40, 160, 240, 0.2); color: #28a0f0; }
        .domain-devtooling { background: rgba(63, 185, 80, 0.2); color: #3fb950; }
        .domain-events { background: rgba(210, 153, 34, 0.2); color: #d29922; }
        .domain-gaming { background: rgba(188, 140, 255, 0.2); color: #bc8cff; }
        .domain-orbit { background: rgba(57, 210, 192, 0.2); color: #39d2c0; }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .pagination-info {
            color: #8b949e;
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            padding: 6px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #161b22;
            border-color: #28a0f0;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: #28a0f0;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: all 0.2s;
            z-index: 1000;
        }

        .chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
        }

        .chat-panel {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 400px;
            height: 600px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
            display: none;
            flex-direction: column;
            z-index: 1001;
        }

        .chat-panel.open {
            display: flex;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 1.1rem;
            color: #28a0f0;
        }

        .chat-close {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            padding: 10px 14px;
            border-radius: 8px;
            max-width: 85%;
        }

        .chat-message.user {
            background: rgba(40, 160, 240, 0.2);
            align-self: flex-end;
        }

        .chat-message.assistant {
            background: #0d1117;
            align-self: flex-start;
        }

        .chat-message.system {
            background: rgba(210, 153, 34, 0.2);
            align-self: center;
            font-size: 0.85rem;
            color: #d29922;
            text-align: center;
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid #30363d;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 0.95rem;
        }

        .chat-send {
            padding: 10px 16px;
            background: #28a0f0;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send:hover {
            background: #1f8cd8;
        }

        .chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 10px 14px;
            background: #0d1117;
            border-radius: 8px;
            color: #8b949e;
            font-size: 0.9rem;
        }

        .typing-indicator.active {
            display: block;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.open {
            display: flex;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.2s;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #30363d;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #8b949e;
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
            padding-right: 40px;
        }

        .modal-subtitle {
            color: #8b949e;
            font-size: 1rem;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section-title {
            font-size: 0.9rem;
            color: #8b949e;
            margin-bottom: 8px;
        }

        .modal-section-content {
            font-size: 1rem;
        }

        .modal-badges {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .milestones-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        .milestones-table th,
        .milestones-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }

        .milestones-table th {
            background: #0d1117;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .milestones-table .total-row {
            font-weight: 600;
            background: #0d1117;
        }

        .questbook-link {
            display: inline-block;
            padding: 10px 20px;
            background: #28a0f0;
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            margin-top: 16px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .questbook-link:hover {
            background: #1f8cd8;
            transform: translateY(-1px);
        }

        footer {
            text-align: center;
            padding: 24px;
            color: #8b949e;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .charts-row {
                grid-template-columns: 1fr;
            }

            .chat-panel {
                width: calc(100vw - 32px);
                height: calc(100vh - 100px);
                right: 16px;
                bottom: 80px;
            }

            table {
                font-size: 0.85rem;
            }

            th:nth-child(n+4),
            td:nth-child(n+4) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Arbitrum DAO Season 3 Grant Dashboard</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </header>

        <!-- Reporting Period -->
        <div class="reporting-period">
            <h2>üìä Reporting Period</h2>
            <div class="date-picker-row">
                <label>Start Date:</label>
                <input type="date" id="startDate">
                <label>End Date:</label>
                <input type="date" id="endDate">
            </div>
            <div class="period-summary" id="periodSummary"></div>
        </div>

        <!-- Sankey Diagram -->
        <div class="sankey-container">
            <h3>Application Flow: Inflow ‚Üí Outcomes</h3>
            <svg id="sankeyDiagram"></svg>
        </div>

        <!-- Inflow/Processed Panels -->
        <div class="panels-row">
            <div class="panel">
                <h3>üì• Inflow (Received in Period)</h3>
                <div class="panel-stats" id="inflowStats"></div>
            </div>
            <div class="panel">
                <h3>‚úÖ Processed (Updated in Period)</h3>
                <div class="panel-stats" id="processedStats"></div>
            </div>
        </div>

        <!-- Domain Cards -->
        <div class="domain-cards" id="domainCards"></div>

        <!-- Stats Row -->
        <div class="stats-row" id="statsRow"></div>

        <!-- Charts -->
        <div class="charts-row">
            <div class="chart-card">
                <h3>Applications by Month</h3>
                <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Applications by State</h3>
                <canvas id="stateChart"></canvas>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <input type="text" class="search-box" id="searchBox" placeholder="Search by project name, applicant, or category...">
            
            <div class="state-buttons" id="stateButtons"></div>

            <div class="advanced-filters">
                <div class="filter-group">
                    <label>Category:</label>
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Funding Range:</label>
                    <input type="number" id="minFunding" placeholder="Min $">
                    <span style="color: #8b949e;">to</span>
                    <input type="number" id="maxFunding" placeholder="Max $">
                </div>
                <button class="toggle-btn" id="milestonesToggle">Has Milestones</button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Domain</th>
                        <th>State</th>
                        <th>Category</th>
                        <th>Funding Ask</th>
                        <th>Grant Amount</th>
                        <th>Age (days)</th>
                        <th>Submitted</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
            <div class="pagination-info" id="paginationInfo"></div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="firstPage">‚Üê First</button>
                <button class="pagination-btn" id="prevPage">‚Äπ Prev</button>
                <span class="pagination-info" id="pageInfo"></span>
                <button class="pagination-btn" id="nextPage">Next ‚Ä∫</button>
                <button class="pagination-btn" id="lastPage">Last ‚Üí</button>
            </div>
        </div>

        <footer>
            Arbitrum DAO Season 3 Grant Dashboard ‚Ä¢ Built with Chart.js
        </footer>
    </div>

    <!-- Chat Button -->
    <button class="chat-button" id="chatButton">üí¨</button>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <h3>Grant Data Assistant</h3>
            <button class="chat-close" id="chatClose">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message system">
                Ask about the grant data. Chat is scoped to your selected reporting period.
            </div>
        </div>
        <div class="typing-indicator" id="typingIndicator">Assistant is typing...</div>
        <div class="chat-input-container" id="chatAuthContainer" style="display:none;">
            <input type="password" class="chat-input" id="chatPasswordInput" placeholder="Enter chat password...">
            <button class="chat-send" id="chatAuthBtn">Unlock</button>
        </div>
        <div class="chat-input-container" id="chatInputContainer">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask a question...">
            <button class="chat-send" id="chatSend">Send</button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" id="modalClose">√ó</button>
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-subtitle" id="modalSubtitle"></div>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // Global state
        let data = null;
        let filteredApps = [];
        let currentPage = 1;
        const itemsPerPage = 25;
        let charts = {};
        
        // Filter state
        let filters = {
            search: '',
            state: 'all',
            domain: 'all',
            category: '',
            minFunding: null,
            maxFunding: null,
            hasMilestones: false,
            startDate: null,
            endDate: null
        };

        // Chat state
        let chatHistory = [];

        // Load data
        async function loadData() {
            try {
                let response = await fetch('/data/all-domains-v2.json');
                if (!response.ok) {
                    response = await fetch('/data/all-domains-data.json');
                }
                data = await response.json();
                
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date(data.lastUpdated).toLocaleString()}`;
                
                initializeDatePickers();
                initializeFilters();
                render();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('lastUpdated').textContent = 'Error loading data';
            }
        }

        // Initialize date pickers with defaults
        function initializeDatePickers() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfNextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            startInput.value = startOfMonth.toISOString().split('T')[0];
            endInput.value = startOfNextMonth.toISOString().split('T')[0];
            
            filters.startDate = startOfMonth;
            filters.endDate = startOfNextMonth;
            
            startInput.addEventListener('change', (e) => {
                filters.startDate = new Date(e.target.value);
                currentPage = 1;
                render();
            });
            
            endInput.addEventListener('change', (e) => {
                filters.endDate = new Date(e.target.value);
                currentPage = 1;
                render();
            });
        }

        // Initialize filters
        function initializeFilters() {
            // State buttons
            const states = ['all', 'submitted', 'approved', 'resubmit', 'rejected'];
            const stateButtons = document.getElementById('stateButtons');
            states.forEach(state => {
                const btn = document.createElement('button');
                btn.className = 'state-btn' + (state === 'all' ? ' active' : '');
                btn.textContent = state === 'all' ? 'All' : state.charAt(0).toUpperCase() + state.slice(1);
                btn.addEventListener('click', () => {
                    filters.state = state;
                    currentPage = 1;
                    document.querySelectorAll('.state-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    render();
                });
                stateButtons.appendChild(btn);
            });

            // Category filter
            const categories = new Set();
            Object.values(data.domains).forEach(domain => {
                Object.keys(domain.categories || {}).forEach(cat => categories.add(cat));
            });
            const categorySelect = document.getElementById('categoryFilter');
            Array.from(categories).sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
            categorySelect.addEventListener('change', (e) => {
                filters.category = e.target.value;
                currentPage = 1;
                render();
            });

            // Search box
            document.getElementById('searchBox').addEventListener('input', (e) => {
                filters.search = e.target.value.toLowerCase();
                currentPage = 1;
                render();
            });

            // Funding range
            document.getElementById('minFunding').addEventListener('input', (e) => {
                filters.minFunding = e.target.value ? parseFloat(e.target.value) : null;
                currentPage = 1;
                render();
            });
            document.getElementById('maxFunding').addEventListener('input', (e) => {
                filters.maxFunding = e.target.value ? parseFloat(e.target.value) : null;
                currentPage = 1;
                render();
            });

            // Milestones toggle
            document.getElementById('milestonesToggle').addEventListener('click', (e) => {
                filters.hasMilestones = !filters.hasMilestones;
                e.target.classList.toggle('active');
                currentPage = 1;
                render();
            });
        }

        // Parse funding string to number
        function parseFunding(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/[$,\s]/g, ''));
        }

        // Get all applications across domains
        function getAllApplications() {
            const apps = [];
            Object.entries(data.domains).forEach(([domainKey, domain]) => {
                (domain.applications || []).forEach(app => {
                    apps.push({ ...app, domainKey, domainName: domain.info.short });
                });
            });
            return apps;
        }

        // Apply filters to get filtered applications
        function getFilteredApplications() {
            let apps = getAllApplications();

            // Period filter (CRITICAL: affects all features)
            if (filters.startDate && filters.endDate) {
                const startTs = filters.startDate.getTime() / 1000;
                const endTs = filters.endDate.getTime() / 1000;
                apps = apps.filter(app => 
                    app.created >= startTs && app.created < endTs
                );
            }

            // State filter
            if (filters.state !== 'all') {
                apps = apps.filter(app => app.state === filters.state);
            }

            // Domain filter
            if (filters.domain !== 'all') {
                apps = apps.filter(app => app.domainKey === filters.domain);
            }

            // Category filter
            if (filters.category) {
                apps = apps.filter(app => app.category === filters.category);
            }

            // Search filter
            if (filters.search) {
                apps = apps.filter(app => {
                    const name = (app.name || app.applicant || '').toLowerCase();
                    const applicant = (app.applicant || '').toLowerCase();
                    const category = (app.category || '').toLowerCase();
                    return name.includes(filters.search) || 
                           applicant.includes(filters.search) || 
                           category.includes(filters.search);
                });
            }

            // Funding range filter
            if (filters.minFunding !== null || filters.maxFunding !== null) {
                apps = apps.filter(app => {
                    const amount = parseFunding(app.fundingAsk || app.grantAmount);
                    if (filters.minFunding !== null && amount < filters.minFunding) return false;
                    if (filters.maxFunding !== null && amount > filters.maxFunding) return false;
                    return true;
                });
            }

            // Milestones filter
            if (filters.hasMilestones) {
                apps = apps.filter(app => app.milestones && app.milestones.length > 0);
            }

            return apps;
        }

        // Get applications for inflow (created in period)
        function getInflowApplications() {
            const apps = getAllApplications();
            if (!filters.startDate || !filters.endDate) return apps;
            
            const startTs = filters.startDate.getTime() / 1000;
            const endTs = filters.endDate.getTime() / 1000;
            return apps.filter(app => app.created >= startTs && app.created < endTs);
        }

        // Get applications for processed (updated in period, not submitted)
        function getProcessedApplications() {
            const apps = getAllApplications();
            if (!filters.startDate || !filters.endDate) return apps;
            
            const startTs = filters.startDate.getTime() / 1000;
            const endTs = filters.endDate.getTime() / 1000;
            return apps.filter(app => 
                app.updated >= startTs && 
                app.updated < endTs && 
                app.state !== 'submitted'
            );
        }

        // Render everything
        function render() {
            filteredApps = getFilteredApplications();
            renderPeriodSummary();
            renderSankey();
            renderPanels();
            renderDomainCards();
            renderStats();
            renderCharts();
            renderTable();
            renderPagination();
        }

        // Render period summary
        function renderPeriodSummary() {
            const inflow = getInflowApplications();
            const processed = getProcessedApplications();
            
            const html = `
                <div class="stat-card">
                    <div class="label">Applications Received</div>
                    <div class="value">${inflow.length}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Applications Processed</div>
                    <div class="value">${processed.length}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Approval Rate</div>
                    <div class="value">${processed.length ? ((processed.filter(a => a.state === 'approved').length / processed.length) * 100).toFixed(1) : 0}%</div>
                </div>
            `;
            document.getElementById('periodSummary').innerHTML = html;
        }

        // Render Sankey diagram
        function renderSankey() {
            const inflow = getInflowApplications();
            const approved = inflow.filter(a => a.state === 'approved').length;
            const rejected = inflow.filter(a => a.state === 'rejected').length;
            const resubmit = inflow.filter(a => a.state === 'resubmit').length;
            const pending = inflow.filter(a => a.state === 'submitted').length;
            
            const svg = document.getElementById('sankeyDiagram');
            const width = svg.clientWidth || 800;
            const height = 400;
            
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            
            // Clear existing content
            svg.innerHTML = '';
            
            const leftX = 100;
            const rightX = width - 200;
            const nodeWidth = 20;
            
            const total = inflow.length;
            if (total === 0) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', width / 2);
                text.setAttribute('y', height / 2);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#8b949e');
                text.textContent = 'No applications in selected period';
                svg.appendChild(text);
                return;
            }
            
            // Calculate positions
            const outcomes = [
                { label: 'Approved', count: approved, color: '#3fb950', y: 0 },
                { label: 'Rejected', count: rejected, color: '#f85149', y: 0 },
                { label: 'Resubmit', count: resubmit, color: '#d29922', y: 0 },
                { label: 'Still Pending', count: pending, color: '#bc8cff', y: 0 }
            ].filter(o => o.count > 0);
            
            const totalHeight = height - 100;
            let currentY = 50;
            outcomes.forEach(outcome => {
                const outcomeHeight = (outcome.count / total) * totalHeight;
                outcome.y = currentY;
                outcome.height = outcomeHeight;
                currentY += outcomeHeight + 20;
            });
            
            const leftNodeHeight = totalHeight;
            const leftY = 50;
            
            // Draw flows (behind)
            outcomes.forEach(outcome => {
                if (outcome.count === 0) return;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const leftMid = leftY + leftNodeHeight / 2;
                const rightMid = outcome.y + outcome.height / 2;
                const d = `M ${leftX + nodeWidth} ${leftMid} 
                          C ${(leftX + rightX) / 2} ${leftMid}, 
                            ${(leftX + rightX) / 2} ${rightMid}, 
                            ${rightX} ${rightMid}`;
                path.setAttribute('d', d);
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke', outcome.color);
                path.setAttribute('stroke-width', outcome.height);
                path.setAttribute('opacity', '0.4');
                svg.appendChild(path);
            });
            
            // Draw left node
            const leftNode = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            leftNode.setAttribute('x', leftX);
            leftNode.setAttribute('y', leftY);
            leftNode.setAttribute('width', nodeWidth);
            leftNode.setAttribute('height', leftNodeHeight);
            leftNode.setAttribute('fill', '#28a0f0');
            svg.appendChild(leftNode);
            
            const leftLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            leftLabel.setAttribute('x', leftX - 10);
            leftLabel.setAttribute('y', leftY + leftNodeHeight / 2);
            leftLabel.setAttribute('text-anchor', 'end');
            leftLabel.setAttribute('fill', '#e6edf3');
            leftLabel.setAttribute('font-size', '14');
            leftLabel.textContent = `Received: ${total}`;
            svg.appendChild(leftLabel);
            
            // Draw right nodes
            outcomes.forEach(outcome => {
                const node = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                node.setAttribute('x', rightX);
                node.setAttribute('y', outcome.y);
                node.setAttribute('width', nodeWidth);
                node.setAttribute('height', outcome.height);
                node.setAttribute('fill', outcome.color);
                svg.appendChild(node);
                
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', rightX + nodeWidth + 10);
                label.setAttribute('y', outcome.y + outcome.height / 2 + 5);
                label.setAttribute('fill', '#e6edf3');
                label.setAttribute('font-size', '14');
                label.textContent = `${outcome.label}: ${outcome.count}`;
                svg.appendChild(label);
            });
        }

        // Render inflow/processed panels
        function renderPanels() {
            const inflow = getInflowApplications();
            const processed = getProcessedApplications();
            
            // Inflow stats
            const inflowByState = {};
            const inflowByDomain = {};
            inflow.forEach(app => {
                inflowByState[app.state] = (inflowByState[app.state] || 0) + 1;
                inflowByDomain[app.domainKey] = (inflowByDomain[app.domainKey] || 0) + 1;
            });
            
            let inflowHtml = `<div class="panel-stat"><span class="label">Total Received</span><span class="value">${inflow.length}</span></div>`;
            Object.entries(inflowByState).forEach(([state, count]) => {
                inflowHtml += `<div class="panel-stat"><span class="label">${state}</span><span class="value">${count}</span></div>`;
            });
            document.getElementById('inflowStats').innerHTML = inflowHtml;
            
            // Processed stats
            const processedByState = {};
            const processedByDomain = {};
            processed.forEach(app => {
                processedByState[app.state] = (processedByState[app.state] || 0) + 1;
                processedByDomain[app.domainKey] = (processedByDomain[app.domainKey] || 0) + 1;
            });
            
            let processedHtml = `<div class="panel-stat"><span class="label">Total Processed</span><span class="value">${processed.length}</span></div>`;
            Object.entries(processedByState).forEach(([state, count]) => {
                processedHtml += `<div class="panel-stat"><span class="label">${state}</span><span class="value">${count}</span></div>`;
            });
            document.getElementById('processedStats').innerHTML = processedHtml;
        }

        // Render domain cards
        function renderDomainCards() {
            const domainCounts = {};
            filteredApps.forEach(app => {
                domainCounts[app.domainKey] = (domainCounts[app.domainKey] || 0) + 1;
            });
            
            const colors = {
                npi: '#28a0f0',
                devtooling: '#3fb950',
                events: '#d29922',
                gaming: '#bc8cff',
                orbit: '#39d2c0'
            };
            
            let html = `
                <div class="domain-card ${filters.domain === 'all' ? 'active' : ''}" onclick="filterByDomain('all')">
                    <div class="domain-name" style="color: #28a0f0;">All Domains</div>
                    <div class="domain-count">${filteredApps.length}</div>
                    <div class="domain-label">applications</div>
                </div>
            `;
            
            Object.entries(data.domains).forEach(([key, domain]) => {
                const count = domainCounts[key] || 0;
                html += `
                    <div class="domain-card ${filters.domain === key ? 'active' : ''}" onclick="filterByDomain('${key}')">
                        <div class="domain-name" style="color: ${colors[key]};">${domain.info.short}</div>
                        <div class="domain-count">${count}</div>
                        <div class="domain-label">applications</div>
                    </div>
                `;
            });
            
            document.getElementById('domainCards').innerHTML = html;
        }

        function filterByDomain(domain) {
            filters.domain = domain;
            currentPage = 1;
            render();
        }

        // Render stats
        function renderStats() {
            const approved = filteredApps.filter(a => a.state === 'approved');
            const approvalRate = filteredApps.length ? (approved.length / filteredApps.length * 100).toFixed(1) : 0;
            
            let totalDisbursed = 0;
            approved.forEach(app => {
                totalDisbursed += parseFunding(app.grantAmount);
            });
            
            const html = `
                <div class="stat-card">
                    <div class="label">Total Applications</div>
                    <div class="value">${filteredApps.length}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Approval Rate</div>
                    <div class="value">${approvalRate}%</div>
                </div>
                <div class="stat-card">
                    <div class="label">Approved Budget</div>
                    <div class="value">$${(totalDisbursed / 1000).toFixed(0)}k</div>
                </div>
            `;
            document.getElementById('statsRow').innerHTML = html;
        }

        // Render charts
        function renderCharts() {
            // Destroy existing charts
            if (charts.monthly) charts.monthly.destroy();
            if (charts.state) charts.state.destroy();
            
            // Monthly chart
            const byMonth = {};
            filteredApps.forEach(app => {
                const date = new Date(app.created * 1000);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                byMonth[key] = (byMonth[key] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(byMonth).sort();
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Applications',
                        data: sortedMonths.map(m => byMonth[m]),
                        backgroundColor: '#28a0f0'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        },
                        x: {
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
            
            // State chart
            const byState = {};
            filteredApps.forEach(app => {
                byState[app.state] = (byState[app.state] || 0) + 1;
            });
            
            const stateColors = {
                submitted: '#bc8cff',
                approved: '#3fb950',
                rejected: '#f85149',
                resubmit: '#d29922',
                review: '#28a0f0',
                cancelled: '#484f58'
            };
            
            const stateCtx = document.getElementById('stateChart').getContext('2d');
            charts.state = new Chart(stateCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(byState),
                    datasets: [{
                        data: Object.values(byState),
                        backgroundColor: Object.keys(byState).map(s => stateColors[s] || '#8b949e')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e6edf3' }
                        }
                    }
                }
            });
        }

        // Render table
        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageApps = filteredApps.slice(start, end);
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = pageApps.map((app, idx) => {
                const name = app.name || app.applicant || 'Unknown';
                const submitted = new Date(app.created * 1000).toLocaleDateString();
                return `
                    <tr onclick="openModal(${start + idx})">
                        <td><strong>${name}</strong></td>
                        <td><span class="domain-badge domain-${app.domainKey}">${app.domainName}</span></td>
                        <td><span class="state-badge state-${app.state}">${app.state}</span></td>
                        <td>${app.category || 'N/A'}</td>
                        <td>${app.fundingAsk || 'N/A'}</td>
                        <td>${app.grantAmount || 'N/A'}</td>
                        <td>${app.ageDays || 'N/A'}</td>
                        <td>${submitted}</td>
                    </tr>
                `;
            }).join('');
        }

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredApps.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(start + itemsPerPage - 1, filteredApps.length);
            
            document.getElementById('paginationInfo').textContent = 
                `Showing ${start}-${end} of ${filteredApps.length} applications`;
            document.getElementById('pageInfo').textContent = 
                `Page ${currentPage} of ${totalPages || 1}`;
            
            document.getElementById('firstPage').disabled = currentPage === 1;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
            document.getElementById('lastPage').disabled = currentPage >= totalPages;
        }

        // Pagination controls
        document.getElementById('firstPage').addEventListener('click', () => {
            currentPage = 1;
            render();
            window.scrollTo(0, 0);
        });
        
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                render();
                window.scrollTo(0, 0);
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredApps.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                render();
                window.scrollTo(0, 0);
            }
        });
        
        document.getElementById('lastPage').addEventListener('click', () => {
            currentPage = Math.ceil(filteredApps.length / itemsPerPage);
            render();
            window.scrollTo(0, 0);
        });

        // Modal
        function openModal(index) {
            const app = filteredApps[index];
            const domain = data.domains[app.domainKey];
            const questbookUrl = `https://arbitrum.questbook.app/dashboard/?grantId=${domain.info.id}&chainId=10&role=community&proposalId=${app.id}`;
            
            const name = app.name || app.applicant || 'Unknown';
            const submitted = new Date(app.created * 1000).toLocaleString();
            const updated = new Date(app.updated * 1000).toLocaleString();
            
            document.getElementById('modalTitle').textContent = name;
            document.getElementById('modalSubtitle').textContent = app.applicant || 'Unknown Applicant';
            
            let milestonesHtml = '<p style="color: #8b949e;">No milestones defined</p>';
            if (app.milestones && app.milestones.length > 0) {
                const total = app.milestones.reduce((sum, m) => sum + m.amount, 0);
                milestonesHtml = `
                    <table class="milestones-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${app.milestones.map((m, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${m.title}</td>
                                    <td>$${m.amount.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                            <tr class="total-row">
                                <td colspan="2">Total</td>
                                <td>$${total.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }
            
            document.getElementById('modalBody').innerHTML = `
                <div class="modal-badges">
                    <span class="state-badge state-${app.state}">${app.state}</span>
                    <span class="domain-badge domain-${app.domainKey}">${app.domainName}</span>
                    ${app.category ? `<span class="domain-badge">${app.category}</span>` : ''}
                </div>
                
                <div class="modal-section">
                    <div class="modal-grid">
                        <div>
                            <div class="modal-section-title">Submitted</div>
                            <div class="modal-section-content">${submitted}</div>
                        </div>
                        <div>
                            <div class="modal-section-title">Last Updated</div>
                            <div class="modal-section-content">${updated}</div>
                        </div>
                        <div>
                            <div class="modal-section-title">Age</div>
                            <div class="modal-section-content">${app.ageDays || 'N/A'} days</div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <div class="modal-grid">
                        <div>
                            <div class="modal-section-title">Funding Ask</div>
                            <div class="modal-section-content">${app.fundingAsk || 'N/A'}</div>
                        </div>
                        ${app.grantAmount ? `
                        <div>
                            <div class="modal-section-title">Grant Amount</div>
                            <div class="modal-section-content">${app.grantAmount}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="modal-section">
                    <div class="modal-section-title">Milestones</div>
                    ${milestonesHtml}
                </div>
                
                <a href="${questbookUrl}" target="_blank" class="questbook-link">View on Questbook ‚Üí</a>
            `;
            
            document.getElementById('modalOverlay').classList.add('open');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('open');
        }

        document.getElementById('modalClose').addEventListener('click', closeModal);
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') closeModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Chat
        document.getElementById('chatButton').addEventListener('click', () => {
            const panel = document.getElementById('chatPanel');
            const wasOpen = panel.classList.contains('open');
            panel.classList.toggle('open');
            if (!wasOpen) initChatAuth();
        });
        
        document.getElementById('chatClose').addEventListener('click', () => {
            document.getElementById('chatPanel').classList.remove('open');
        });
        
        // Chat auth
        function getChatToken() { return localStorage.getItem('chat_token') || ''; }
        function setChatToken(t) { localStorage.setItem('chat_token', t); }
        function clearChatToken() { localStorage.removeItem('chat_token'); }

        function showChatAuth() {
            document.getElementById('chatAuthContainer').style.display = 'flex';
            document.getElementById('chatInputContainer').style.display = 'none';
            document.getElementById('chatPasswordInput').value = '';
            document.getElementById('chatPasswordInput').focus();
        }
        function showChatInput() {
            document.getElementById('chatAuthContainer').style.display = 'none';
            document.getElementById('chatInputContainer').style.display = 'flex';
            document.getElementById('chatInput').focus();
        }

        function initChatAuth() {
            if (getChatToken()) showChatInput();
            else showChatAuth();
        }

        document.getElementById('chatAuthBtn').addEventListener('click', () => {
            const pw = document.getElementById('chatPasswordInput').value.trim();
            if (pw) { setChatToken(pw); showChatInput(); }
        });
        document.getElementById('chatPasswordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const pw = document.getElementById('chatPasswordInput').value.trim();
                if (pw) { setChatToken(pw); showChatInput(); }
            }
        });

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const messagesDiv = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = message;
            messagesDiv.appendChild(userMsg);
            
            input.value = '';
            input.disabled = true;
            document.getElementById('chatSend').disabled = true;
            document.getElementById('typingIndicator').classList.add('active');
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getChatToken()
                    },
                    body: JSON.stringify({
                        message,
                        history: chatHistory,
                        periodStart: filters.startDate.toISOString(),
                        periodEnd: filters.endDate.toISOString()
                    })
                });
                
                if (response.status === 401) {
                    clearChatToken();
                    const errMsg = document.createElement('div');
                    errMsg.className = 'chat-message system';
                    errMsg.textContent = 'Invalid password. Please re-enter.';
                    messagesDiv.appendChild(errMsg);
                    showChatAuth();
                    return;
                }
                
                const data = await response.json();
                
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'chat-message assistant';
                assistantMsg.textContent = data.reply || data.response || 'No response';
                messagesDiv.appendChild(assistantMsg);
                
                chatHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: data.reply || data.response || '' }
                );
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Chat error:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-message system';
                errorMsg.textContent = 'Error: Could not reach chat service';
                messagesDiv.appendChild(errorMsg);
            } finally {
                input.disabled = false;
                document.getElementById('chatSend').disabled = false;
                document.getElementById('typingIndicator').classList.remove('active');
            }
        }
        
        document.getElementById('chatSend').addEventListener('click', sendMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Initialize
        loadData();
    </script>
</body>
</html>